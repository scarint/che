schemaVersion: 2.2.2
metadata:
  name: intellij-manual-launch
  displayName: IntelliJ (Manual Launch)
components:
  - name: tools
    container:
      image: quay.io/devfile/universal-developer-image:ubi8-latest
      memoryLimit: 4Gi
      mountSources: true
      endpoints:
        - name: intellij-direct
          targetPort: 9999
          attributes:
            public: "true"
            protocol: http
            secure: "false"
            discoverable: "true"
      env:
        - name: HOME
          value: /projects
      command: ["/bin/sh", "-c"]
      args:
        - |
          set -e
          echo ">>> [1/4] INITIALIZING ENVIRONMENT"

          # 1. FIX IDENTITY
          if ! grep -q "1234" /etc/passwd; then
            echo "    Fixing Identity..."
            echo "user:x:1234:0:User:${HOME}:/bin/bash" >> /etc/passwd
          fi
          
          # 2. INSTALL PROJECTOR
          export PATH=$PATH:$HOME/.local/bin
          if ! command -v projector &> /dev/null; then
             echo ">>> [2/4] INSTALLING SOFTWARE"
             pip3 install projector-installer --user
          fi
          
          # --- THE MISSING PATCH (Restored) ---
          SITE_PACKAGES=$HOME/.local/lib/python3.11/site-packages
          TARGET_FILE="$SITE_PACKAGES/projector_installer/products.py"
          if [ -f "$TARGET_FILE" ]; then
             if ! grep -q "from dataclasses import dataclass, field" "$TARGET_FILE"; then
                echo ">>> [2.5/4] APPLYING PYTHON 3.11 PATCH"
                sed -i 's/from dataclasses import dataclass.*/from dataclasses import dataclass, field/' "$TARGET_FILE"
                sed -i 's/ver: LooseVersion = .*/ver: LooseVersion = field(default_factory=lambda: LooseVersion("0.0.0"))/' "$TARGET_FILE"
             fi
          fi
          # ------------------------------------
          
          # 3. INSTALL INTELLIJ
          # We check if the specific version folder exists to skip download
          APP_PATH="$HOME/.projector/apps/idea-IC-213.6777.52"
          
          if [ ! -d "$APP_PATH" ]; then
             echo ">>> [3/4] INSTALLING IDE"
             printf "y\ny\n5\n" | projector install IDEA_COMMUNITY
          else
             echo ">>> [3/4] FOUND EXISTING IDE"
          fi
          
          # 4. LAUNCH MANUALLY
          echo ">>> [4/4] STARTING JAVA SERVER"
          
          # Construct classpath
          LIB_PATH="$HOME/.local/lib/python3.11/site-packages/projector_installer/bundled/server/*"
          
          # Verify paths exist before launching
          if [ ! -f "$APP_PATH/jbr/bin/java" ]; then
             echo "CRITICAL ERROR: Java binary not found at $APP_PATH/jbr/bin/java"
             exit 1
          fi

          # The Command (HOST=0.0.0.0 enforced)
          $APP_PATH/jbr/bin/java \
            -classpath "$APP_PATH/lib/util.jar:$APP_PATH/lib/bootstrap.jar:$LIB_PATH" \
            -Xms128m -Xmx2048m \
            -XX:ReservedCodeCacheSize=512m \
            -XX:+IgnoreUnrecognizedVMOptions \
            -XX:+UseG1GC \
            -XX:SoftRefLRUPolicyMSPerMB=50 \
            -XX:CICompilerCount=2 \
            -XX:+HeapDumpOnOutOfMemoryError \
            -XX:-OmitStackTraceInFastThrow \
            -ea \
            -Dsun.io.useCanonCaches=false \
            -Djdk.http.auth.tunneling.disabledSchemes="" \
            -Djdk.attach.allowAttachSelf=true \
            -Djdk.module.illegalAccess.silent=true \
            -Dkotlinx.coroutines.debug=off \
            -Dsun.tools.attach.tmp.only=true \
            -Djb.vmOptionsFile=$APP_PATH/bin/idea64.vmoptions \
            -Djava.system.class.loader=com.intellij.util.lang.PathClassLoader \
            -Didea.vendor.name=JetBrains \
            -Didea.paths.selector=IdeaIC2021.3 \
            -Didea.platform.prefix=Idea \
            -Didea.jre.check=true \
            -Dsplash=true \
            -DORG_JETBRAINS_PROJECTOR_SERVER_PORT=9999 \
            -Dorg.jetbrains.projector.server.classToLaunch=com.intellij.idea.Main \
            -DORG_JETBRAINS_PROJECTOR_SERVER_HOST=0.0.0.0 \
            org.jetbrains.projector.server.ProjectorLauncher
