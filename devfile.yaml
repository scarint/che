schemaVersion: 2.2.2
metadata:
  name: python-configmap-fix-v2
  displayName: Python (ConfigMap Fix V2)
  attributes:
    app.che.eclipse.org/editor: che-incubator/che-code/latest
components:
  - name: tools
    container:
      image: quay.io/devfile/universal-developer-image:ubi8-latest
      memoryLimit: 2Gi
      mountSources: true
      args: ['tail', '-f', '/dev/null']
      endpoints:
        - name: https-python
          targetPort: 8080
          protocol: https
      env:
        # 1. Force Identity Spoofing
        - name: LD_PRELOAD
          value: "/usr/lib64/libnss_wrapper.so"
        - name: NSS_WRAPPER_PASSWD
          value: "/etc/config/passwd"
        - name: NSS_WRAPPER_GROUP
          value: "/etc/config/group"
        - name: HOME
          value: /projects
      volumeMounts:
        # 2. Mount the ConfigMap files
        - name: identity-volume
          path: /etc/config
  - name: identity-volume
    kubernetes:
      # THE FIX: This pipe (|) makes it a string, satisfying the schema
      inlined: |
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: fake-passwd
commands:
  - id: run-app
    exec:
      commandLine: python app.py
      workingDir: ${PROJECT_SOURCE}
      component: tools
      group:
        kind: run
        isDefault: true
starterProjects:
  - name: flask-example
    git:
      remotes:
        origin: https://github.com/devfile-samples/python-ex
